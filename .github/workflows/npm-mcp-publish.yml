name: Publish MCP npm package

on:
  push:
    tags:
      - "mcp-v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Package version to publish (ex: 0.1.0). Optional if using mcp-v* tag."
        required: false
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      PACKAGE_DIR: npm/phtui-mcp
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org

      - name: Resolve publish version
        id: resolve
        shell: bash
        run: |
          set -euo pipefail

          version=""

          if [[ "${GITHUB_REF_TYPE:-}" == "tag" && "${GITHUB_REF_NAME:-}" == mcp-v* ]]; then
            version="${GITHUB_REF_NAME#mcp-v}"
          elif [[ -n "${{ github.event.inputs.version || '' }}" ]]; then
            version="${{ github.event.inputs.version }}"
          else
            version="$(node -p "require('./${PACKAGE_DIR}/package.json').version")"
          fi

          if [[ ! "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+([.-][0-9A-Za-z.-]+)?$ ]]; then
            echo "Invalid semver: $version"
            exit 1
          fi

          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "Publishing version: $version"

      - name: Set package version (runner only)
        shell: bash
        run: |
          set -euo pipefail
          cd "${PACKAGE_DIR}"
          npm version "${{ steps.resolve.outputs.version }}" --no-git-tag-version --allow-same-version

      - name: Validate package contents
        shell: bash
        run: |
          set -euo pipefail
          cd "${PACKAGE_DIR}"
          npm pack --dry-run

      - name: Resolve npm token
        id: resolve_token
        shell: bash
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_SECRET_TOKEN: ${{ secrets.NPM_SECRET }}
          NPT_TOKEN: ${{ secrets.NPT_TOKEN }}
        run: |
          set -euo pipefail

          token="${NPM_TOKEN:-}"
          if [[ -z "$token" ]]; then
            token="${NPM_SECRET_TOKEN:-}"
          fi
          if [[ -z "$token" ]]; then
            token="${NPT_TOKEN:-}"
          fi
          if [[ -z "$token" ]]; then
            echo "Missing npm token. Set repository secret NPM_TOKEN (preferred), NPM_SECRET, or NPT_TOKEN."
            exit 1
          fi

          echo "::add-mask::$token"
          echo "token=$token" >> "$GITHUB_OUTPUT"

      - name: Publish to npm
        uses: JS-DevTools/npm-publish@v4
        with:
          token: ${{ steps.resolve_token.outputs.token }}
          package: ./npm/phtui-mcp
          access: public
          provenance: true
